<:Window on:resize="resize()"/>

<figure ref:root class="l-body">
    {{#await resourcePromise}}
      <p>wait for it...</p>
    {{then resources}}
      <THREEjsView ref:view resources={{resources}} :textureUrl :width :height :enableZoom bind:unfoldFlag autoRotate={{false}}></THREEjsView>
    {{catch error}}
      <p>well that's odd</p>
    {{/await}}
</figure>
<div class="controls">
  <ToggleSwitch bind:checked='unfoldFlag' text="unfold texture"></ToggleSwitch>
</div>


<style>
  .controls {
    margin-top: 10px;
    text-align: center;
  }
</style>


<script>
import ToggleSwitch from '../components/ToggleSwitch';
import THREEjsView from '../components/THREEjsView';

export default {
  components: { THREEjsView, ToggleSwitch },
  oncreate() {
    setTimeout(() => { this.resize(); }, 200);
  },
  data() {
    return {
      model_folder: 'models/bunny',
      faces_file: 'face.3d',
      positions_file: 'position.3d',
      uvs_file: 'uv.3d',
      texture_file: 'tex.png',
      resourcesReady: false,
      texture_index: 0,
      enableZoom: false,
      width: 400,
      height: 400,
      unfoldFlag: false
    }
  },
  computed: {
    textureUrl: (model_folder, texture_file) => {
      return model_folder + '/' + texture_file;
    },
    resources: (model_folder, faces_file, positions_file, uvs_file) => {
      return new Map([
        ['positions', [model_folder + '/' + positions_file, Float32Array]],
        ['uvs', [model_folder + '/' + uvs_file, Float32Array]],
        ['faces', [model_folder + '/' + faces_file, Uint32Array]],
      ]);
    },
    resourcePromise: (resources) => {
      return Promise.all([...resources].map(([resource, [path, DType]]) => {
        return fetch(path).then((response) => {
          return response.arrayBuffer();
        }).then((arrayBuffer) => {
          return new DType(arrayBuffer);
        });
      }));
    }
  },
  methods: {
    resize: function() {
      const bb = this.refs.root.getBoundingClientRect();
      this.set({width: bb.width });
    }
  }
}
</script>
