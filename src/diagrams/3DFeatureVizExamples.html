<:Window on:resize="resize()"/>

<figure class="base-grid">

  <figcaption style="grid-column: kicker;">
    Textures are generated by optimizing for a feature visualization objective function.
    Seams in the textures are hardly visible and the patterns are correctly oriented.
    <div class="controls">
      <ToggleSwitch bind:checked='unfoldFlag' text="unfold texture"></ToggleSwitch>
    </div>

  </figcaption>

  <div class="l-body">
    <div class="example-selector">
      <ExampleSelector :spriteUrl bind:index spriteWidth={{128}} spriteColumns={{8}}></ExampleSelector>
    </div>
    <div ref:threejsContainer class="THREEjsview">
      {{#await resourcePromise}}
        <p>Loading the 3D model...</p>
      {{then resources}}
        <THREEjsView ref:view resources={{resources}} textureUrl={{textureUrl}} :backgroundColor :width :height bind:unfoldFlag></THREEjsView>
      {{catch error}}
        <p>A problem occurred while loading the 3D model!</p>
      {{/await}}
    </div>
  </div>

</figure>


<style>

</style>


<script>
import ExampleSelector from '../components/ExampleSelector';
import ToggleSwitch from '../components/ToggleSwitch';
import THREEjsView from '../components/THREEjsView';
import Sprite from '../components/Sprite.html';

function range(n){
  return Array(n).fill().map((_, i) => i);
}

export default {
  components: { THREEjsView, Sprite, ExampleSelector, ToggleSwitch },
  oncreate() {
    setTimeout(() => { this.resize(); }, 200);
  },
  data() {
    return {
      model_folder: 'models/bunny',
      texture_folder: 'models/bunny/3Dfeatureviz',
      spriteUrl: 'models/bunny/3Dfeatureviz/feature_sprite.jpg',
      faces_file: 'face.3d',
      positions_file: 'position.3d',
      uvs_file: 'uv.3d',
      texture_files: ['texture_0.jpg', 'texture_1.jpg', 'texture_2.jpg', 'texture_3.jpg',
                      'texture_4.jpg', 'texture_5.jpg', 'texture_6.jpg', 'texture_7.jpg'],
      resourcesReady: false,
      backgroundColor: '#f8f8f8',
      texture_index: 0,
      index: 0,
      width: 600,
      height: 400
    }
  },
  computed: {
    textureUrls: (texture_folder, texture_files) => {
      return texture_files.map((texture) => texture_folder + '/' + texture);
    },
    textureUrl: (textureUrls, index) => textureUrls[index],
    resources: (model_folder, faces_file, positions_file, uvs_file) => {
      return new Map([
        ['positions', [model_folder + '/' + positions_file, Float32Array]],
        ['uvs', [model_folder + '/' + uvs_file, Float32Array]],
        ['faces', [model_folder + '/' + faces_file, Uint32Array]],
      ]);
    },
    resourcePromise: (resources) => {
      return Promise.all([...resources].map(([resource, [path, DType]]) => {
        return fetch(path).then((response) => {
          return response.arrayBuffer();
        }).then((arrayBuffer) => {
          return new DType(arrayBuffer);
        });
      }));
    }
  },
  methods: {
    resize: function() {
      const bb = this.refs.threejsContainer.getBoundingClientRect();
      this.set({width: bb.width });
    }
  },
  helpers: {range}
}
</script>
