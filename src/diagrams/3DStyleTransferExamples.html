<:Window on:resize="resize()"/>

<figure id="style-transfer-examples" class="grid">
  
<div id="input-content" class="input-wrapper">
  <h4>Content Image</h4>
  <div class="input-chooser">
    <ExampleSelector items={{contentImages}} bind:index='contentIndex'></ExampleSelector>
    <div id="sprite-first" class="sprite">
      <div style="background-image: url('images/bunny-content.png')"></div>
    </div>
  </div>
</div>

<div id="input-style" class="input-wrapper">
  <h4>Style Image</h4>
  <div class="input-chooser">
    <ExampleSelector items={{styleImages}} bind:index='styleIndex'></ExampleSelector>
    <div id="sprite-second" class="sprite">
      <div style="background-image: url({{styleImage.src}})" class="{{styleImage.rotated? 'rotated' : ''}}"></div>
    </div>
  </div>
</div>


<img class="arrow" src="images/vertical-join-arrow.svg"/>

<div id="output">
  <h4>Final image Optimization</h4>
  <div ref:sizer class="THREEjsview">
    {{#await resourcePromise}}
      <p>Loading the 3D model...</p>
    {{then resources}}
      <THREEjsView ref:view :resources :textureUrl :width :height bind:unfoldFlag></THREEjsView>
    {{catch error}}
      <p>A problem occurred while loading the 3D model!</p>
    {{/await}}
  </div>
</div>

</figure>

<span class="figcaption l-body">
  Styletransfer of "{{styleImage.title}}" onto a 3D model by Greg Turk and Marc Levoy. 
  <div class="controls">
    <ToggleSwitch bind:checked='unfoldFlag' text="unfold texture"></ToggleSwitch> 
  </div>
</span>
<span class="figcaption l-body">
  <!-- Move the slider to compare optimization in pixel space and in the fourier basis. Both images were created with the same optimization process and differ only in their parameterization. -->
</span>

<style>

#style-transfer-examples {
  grid-column: page-start / text-end;
}

.grid {
  display: grid;
  grid-auto-flow: row;
  grid-gap: 10px;
  grid-auto-columns: 1fr;
  align-items: flex-start;
  grid-template: 
    "style content" auto
    "output output" auto / 1fr 1fr;
}

.row {
  grid-auto-flow: column;
}

#input-style {
  grid-area: style;
}

#input-content {
  grid-area: content;
}

#output {
  display: grid;
  grid-area: output;
  grid-gap: inherit;
  grid-template-rows: min-content auto;
  height: 100%;
}

.input-wrapper {
  display: grid;
  grid-gap: inherit;
  align-items: flex-start;
  grid-auto-rows: min-content auto;
  z-index: 1;
}

.input-chooser {
  display: grid;
  grid-gap: inherit;
  align-items: flex-start;
}

.arrow {
  display: none;
  z-index: 0;
}

h4 {
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding-bottom: 8px;
  margin: 0;
  font-weight: 700;
}

.sprite div {
  /* flex: 1 1; */
  position: relative;
  /* width: 1vw; */
  /* height: 10vw; */
  /* height: 0; */
  /* padding-top: 100%; */
  background-size: cover;
  background-position: center;
}
.sprite div:before {
  content: "";
	display: block;
	padding-top: 100%;
}
.rotated {
  transform: rotate(90deg);
}

.figcaption {
  margin-top: 10px;
}

.THREEjsview {
  align-self: stretch;
  overflow: hidden;
  display: flex;
  align-items: center;
}

@media (min-width: 768px) {
  .input-chooser {
    grid-auto-flow: column;
    grid-template-columns: 94px auto;
  }
}

@media (min-width: 1180px) {
  .grid {
    grid-template: 
      "style arrow output" 1fr
      "content arrow output" 1fr / min-content 34px 1fr;
  }
  .sprite {
    min-width: 210px; /* magic number */
  }
  .arrow {
    display: initial;
    position: absolute;
    left: -20px;
    top: 106px;
    z-index: 0;
    grid-area: arrow;
    width: unset;
  }
}
</style>

<script>
  import { range } from '../util';
  import THREEjsView from '../components/THREEjsView';
  import ToggleSwitch from '../components/ToggleSwitch';
  import ImageComparison from '../components/ImageComparison'
  import ExampleSelector from '../components/ExampleSelector'

  export default {
    components: { ImageComparison, ExampleSelector, THREEjsView, ToggleSwitch },
    computed: {
      styleImage: (styleImages, styleIndex) => styleImages[styleIndex],
      textureUrl: (styleImage) => styleImage.texture,
      resources: (model_folder, faces_file, positions_file, uvs_file) => {
        return new Map([
          ['positions', [model_folder + '/' + positions_file, Float32Array]],
          ['uvs', [model_folder + '/' + uvs_file, Float32Array]],
          ['faces', [model_folder + '/' + faces_file, Uint16Array]],
        ]);
      },
      resourcePromise: (resources) => {
        return Promise.all([...resources].map(([resource, [path, DType]]) => {
          return fetch(path).then((response) => {
            return response.arrayBuffer();
          }).then((arrayBuffer) => {
            return new DType(arrayBuffer);
          });
        }));
      }
    },
    oncreate() {
      setTimeout(() => { this.resize(); }, 200);
    },
    data() {
      return {
        model_folder: 'models/bunny',
        faces_file: 'face.3d',
        positions_file: 'position.3d',
        uvs_file: 'uv.3d',
        resourcesReady: false,
        styleIndex: 0,
        contentIndex: 0,
        width: 600,
        height: 400,
        unfoldFlag: false,
        styleImages: [
          {
            texture: 'models/bunny/3Dstyles/texture_cd.jpg',
            src: 'models/bunny/3Dstyles/styles/cd.jpg',
            title: 'CD',
            link: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/CD_autolev_crop.jpg/480px-CD_autolev_crop.jpg"
          },
          // {
          //   texture: 'models/bunny/3Dstyles/texture_cross.jpg',
          //   src: 'models/bunny/3Dstyles/styles/cross.jpg',
          //   title: 'Cross stitch detail',
          //   link: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/50/Cross_stitch_detail.jpg/640px-Cross_stitch_detail.jpg"
          // },
          // {
          //   texture: 'models/bunny/3Dstyles/texture_galaxy.jpg',
          //   src: 'models/bunny/3Dstyles/styles/galaxy.jpg',
          //   title: 'Galaxy',
          //   link: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/NGC_4414_%28NASA-med%29.jpg/582px-NGC_4414_%28NASA-med%29.jpg",
          // },
          // {
          //   texture: 'models/bunny/3Dstyles/texture_mosaic.jpg',
          //   src: 'models/bunny/3Dstyles/styles/mosaic.jpg',
          //   title: "Leger's Grand Parade",
          //   link: "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9e/Fernand_L%C3%A9ger_-_Grand_parade_with_red_background_%28mosaic%29_1958_made.jpg/637px-Fernand_L%C3%A9ger_-_Grand_parade_with_red_background_%28mosaic%29_1958_made.jpg",
          // },
          {
            texture: 'models/bunny/3Dstyles/texture_newspaper.jpg',
            src: 'models/bunny/3Dstyles/styles/newspaper.jpg',
            title: 'Newspaper',
            link: "https://upload.wikimedia.org/wikipedia/commons/d/db/RIAN_archive_409362_Literaturnaya_Gazeta_article_about_YuriGagarin%2C_first_man_in_space.jpg"
          },
          {
            texture: 'models/bunny/3Dstyles/texture_noodles.jpg',
            src: 'models/bunny/3Dstyles/styles/noodles.jpg',
            title: 'Noodles and eggs',
            link:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d9/Noodles_and_eggs20170520_1035.jpg/526px-Noodles_and_eggs20170520_1035.jpg"
          },
          {
            texture: 'models/bunny/3Dstyles/texture_onwhite.jpg',
            src: 'models/bunny/3Dstyles/styles/on_white.jpg',
            title: "Kandinsky's On White",
            link: "https://upload.wikimedia.org/wikipedia/commons/c/c4/Vassily_Kandinsky%2C_1923_-_On_White_II.jpg"
          },
          {
            texture: 'models/bunny/3Dstyles/texture_points.jpg',
            src: 'models/bunny/3Dstyles/styles/points.jpg',
            title: "Delaunay's Portrait de Metzinger",
            link: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c9/Robert_Delaunay%2C_1906%2C_Portrait_de_Metzinger%2C_oil_on_canvas%2C_55_x_43_cm%2C_DSC08255.jpg/449px-Robert_Delaunay%2C_1906%2C_Portrait_de_Metzinger%2C_oil_on_canvas%2C_55_x_43_cm%2C_DSC08255.jpg",
          },
          // {
          //   texture: 'models/bunny/3Dstyles/texture_scream.jpg',
          //   src: 'models/bunny/3Dstyles/styles/scream.jpg',
          //   title: "Munch's The Scream",
          //   link: "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/The_Scream.jpg/471px-The_Scream.jpg"
          // },
          {
            texture: 'models/bunny/3Dstyles/texture_starry.jpg',
            src: 'models/bunny/3Dstyles/styles/starry_night.jpg',
            title: "Van Gogh's Starry Night ",
            link: "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/606px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg",
          },
        ],
        contentImages: [
          {src: 'images/bunny-content.png'}
        ]
      };
    },
    methods: {
      resize: function() {
        const bb = this.refs.sizer.getBoundingClientRect();
        console.debug(bb.width)
        this.set({width: bb.width });
      }
    },
    helpers: {
      range,
    }
  }
</script>
